import 'package:flutter/material.dart';
import 'package:camera/camera.dart';
import 'package:glassmorphism/glassmorphism.dart';
import 'card_scanner_service.dart';

class ScannerScreen extends StatefulWidget {
  const ScannerScreen({super.key});

  @override
  State<ScannerScreen> createState() => _ScannerScreenState();
}

class _ScannerScreenState extends State<ScannerScreen> with WidgetsBindingObserver {
  CameraController? _cameraController;
  final CardScannerService _scannerService = CardScannerService();
  
  bool _isScanning = false;
  bool _isProcessing = false;
  PokemonCard? _detectedCard;
  String _statusText = 'Halte eine Pokémon-Karte vor die Kamera';
  
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _initializeCamera();
  }
  
  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _cameraController?.dispose();
    _scannerService.dispose();
    super.dispose();
  }
  
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    final controller = _cameraController;
    if (controller == null || !controller.value.isInitialized) return;
    
    if (state == AppLifecycleState.inactive) {
      controller.dispose();
    } else if (state == AppLifecycleState.resumed) {
      _initializeCamera();
    }
  }
  
  /// Initialisiert die Kamera
  Future<void> _initializeCamera() async {
    try {
      final cameras = await availableCameras();
      if (cameras.isEmpty) {
        _showError('Keine Kamera gefunden');
        return;
      }
      
      // Nutze Rückkamera
      final camera = cameras.firstWhere(
        (cam) => cam.lensDirection == CameraLensDirection.back,
        orElse: () => cameras.first,
      );
      
      _cameraController = CameraController(
        camera,
        ResolutionPreset.high,
        enableAudio: false,
        imageFormatGroup: ImageFormatGroup.nv21, // Für Android OCR
      );
      
      await _cameraController!.initialize();
      
      if (!mounted) return;
      
      setState(() {});
      _startScanning();
      
    } catch (e) {
      _showError('Kamera-Fehler: $e');
    }
  }
  
  /// Startet den kontinuierlichen Scan-Prozess
  void _startScanning() {
    if (_isScanning) return;
    
    setState(() {
      _isScanning = true;
      _statusText = 'Scanning...';
    });
    
    _cameraController!.startImageStream((CameraImage image) async {
      // Nur scannen, wenn nicht bereits ein Frame verarbeitet wird
      if (_isProcessing) return;
      
      _isProcessing = true;
      
      try {
        final card = await _scannerService.scanFrame(image);
        
        if (card != null && mounted) {
          // Karte gefunden! Stream stoppen
          await _cameraController!.stopImageStream();
          
          setState(() {
            _detectedCard = card;
            _isScanning = false;
            _isProcessing = false;
          });
          
          // Zeige Bottom Sheet
          _showCardDetails(card);
        }
      } catch (e) {
        print('Frame-Verarbeitung fehlgeschlagen: $e');
      }
      
      _isProcessing = false;
    });
  }
  
  /// Zeigt die erkannte Karte in einem Bottom Sheet
  void _showCardDetails(PokemonCard card) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      builder: (context) => _CardDetailsSheet(
        card: card,
        onClose: () {
          Navigator.pop(context);
          _resumeScanning();
        },
        onAddToCollection: () async {
          Navigator.pop(context);
          await _addToCollection(card);
          _resumeScanning();
        },
      ),
    );
  }
  
  /// Fügt Karte zur Supabase-Datenbank hinzu
  Future<void> _addToCollection(PokemonCard card) async {
    final supabase = SupabaseService();
    
    if (!supabase.isLoggedIn) {
      if (!mounted) return;
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text('⚠️ Bitte erst einloggen'),
          backgroundColor: Colors.orange[900],
          action: SnackBarAction(
            label: 'Login',
            textColor: Colors.white,
            onPressed: () {
              // Navigiere zum Login (wird in main.dart implementiert)
            },
          ),
        ),
      );
      return;
    }
    
    try {
      await supabase.addCardToCollection(
        card: card,
        condition: 'Near Mint',
      );
      
      if (!mounted) return;
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('✅ ${card.name} zur Sammlung hinzugefügt!'),
          backgroundColor: Colors.green[900],
        ),
      );
      
    } catch (e) {
      if (!mounted) return;
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('❌ Fehler: $e'),
          backgroundColor: Colors.red[900],
        ),
      );
    }
  }
  
  /// Setzt den Scan-Prozess fort
  void _resumeScanning() {
    setState(() {
      _detectedCard = null;
      _statusText = 'Halte eine Pokémon-Karte vor die Kamera';
    });
    
    Future.delayed(const Duration(milliseconds: 500), () {
      if (mounted && _cameraController != null) {
        _startScanning();
      }
    });
  }
  
  /// Zeigt Fehlermeldung
  void _showError(String message) {
    if (!mounted) return;
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red[900],
      ),
    );
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFF0A0E1A),
      body: Stack(
        children: [
          // Kamera-Vorschau
          if (_cameraController != null && _cameraController!.value.isInitialized)
            SizedBox.expand(
              child: CameraPreview(_cameraController!),
            )
          else
            const Center(
              child: CircularProgressIndicator(
                color: Colors.white,
              ),
            ),
          
          // Dunkel-Overlay mit Ausschnitt
          CustomPaint(
            size: Size.infinite,
            painter: _ScanOverlayPainter(),
          ),
          
          // Top-Bar
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(20),
              child: Row(
                children: [
                  // Zurück-Button
                  GlassmorphicContainer(
                    width: 50,
                    height: 50,
                    borderRadius: 25,
                    blur: 10,
                    border: 2,
                    linearGradient: LinearGradient(
                      colors: [
                        Colors.white.withOpacity(0.1),
                        Colors.white.withOpacity(0.05),
                      ],
                    ),
                    borderGradient: LinearGradient(
                      colors: [
                        Colors.white.withOpacity(0.2),
                        Colors.white.withOpacity(0.1),
                      ],
                    ),
                    child: IconButton(
                      icon: const Icon(Icons.arrow_back, color: Colors.white),
                      onPressed: () => Navigator.pop(context),
                    ),
                  ),
                ],
              ),
            ),
          ),
          
          // Status-Text
          Positioned(
            bottom: 100,
            left: 20,
            right: 20,
            child: GlassmorphicContainer(
              width: double.infinity,
              height: 70,
              borderRadius: 20,
              blur: 20,
              border: 2,
              linearGradient: LinearGradient(
                colors: [
                  Colors.white.withOpacity(0.15),
                  Colors.white.withOpacity(0.05),
                ],
              ),
              borderGradient: LinearGradient(
                colors: [
                  Colors.white.withOpacity(0.3),
                  Colors.white.withOpacity(0.1),
                ],
              ),
              child: Center(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      if (_isScanning)
                        const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation(Colors.white),
                          ),
                        ),
                      if (_isScanning) const SizedBox(width: 15),
                      Flexible(
                        child: Text(
                          _statusText,
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/// Custom Painter für das Scan-Overlay
class _ScanOverlayPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()..color = Colors.black.withOpacity(0.6);
    
    // Ausschnitt-Rechteck (Kartengröße)
    final cardWidth = size.width * 0.75;
    final cardHeight = cardWidth * 1.4; // Standard Pokémon-Karten-Ratio
    
    final left = (size.width - cardWidth) / 2;
    final top = (size.height - cardHeight) / 2;
    
    final cardRect = Rect.fromLTWH(left, top, cardWidth, cardHeight);
    
    // Zeichne dunklen Bereich außerhalb des Rechtecks
    final path = Path()
      ..addRect(Rect.fromLTWH(0, 0, size.width, size.height))
      ..addRRect(RRect.fromRectAndRadius(cardRect, const Radius.circular(20)))
      ..fillType = PathFillType.evenOdd;
    
    canvas.drawPath(path, paint);
    
    // Zeichne Ecken
    final cornerPaint = Paint()
      ..color = Colors.white
      ..strokeWidth = 4
      ..strokeCap = StrokeCap.round
      ..style = PaintingStyle.stroke;
    
    const cornerLength = 30.0;
    
    // Ecke oben links
    canvas.drawLine(
      Offset(left, top + cornerLength),
      Offset(left, top),
      cornerPaint,
    );
    canvas.drawLine(
      Offset(left, top),
      Offset(left + cornerLength, top),
      cornerPaint,
    );
    
    // Ecke oben rechts
    canvas.drawLine(
      Offset(left + cardWidth - cornerLength, top),
      Offset(left + cardWidth, top),
      cornerPaint,
    );
    canvas.drawLine(
      Offset(left + cardWidth, top),
      Offset(left + cardWidth, top + cornerLength),
      cornerPaint,
    );
    
    // Ecke unten links
    canvas.drawLine(
      Offset(left, top + cardHeight - cornerLength),
      Offset(left, top + cardHeight),
      cornerPaint,
    );
    canvas.drawLine(
      Offset(left, top + cardHeight),
      Offset(left + cornerLength, top + cardHeight),
      cornerPaint,
    );
    
    // Ecke unten rechts
    canvas.drawLine(
      Offset(left + cardWidth - cornerLength, top + cardHeight),
      Offset(left + cardWidth, top + cardHeight),
      cornerPaint,
    );
    canvas.drawLine(
      Offset(left + cardWidth, top + cardHeight - cornerLength),
      Offset(left + cardWidth, top + cardHeight),
      cornerPaint,
    );
  }
  
  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}

/// Bottom Sheet für Karten-Details
class _CardDetailsSheet extends StatelessWidget {
  final PokemonCard card;
  final VoidCallback onClose;
  
  const _CardDetailsSheet({
    required this.card,
    required this.onClose,
  });
  
  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.75,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF1A1F3A),
            const Color(0xFF0A0E1A),
          ],
        ),
        borderRadius: const BorderRadius.only(
          topLeft: Radius.circular(30),
          topRight: Radius.circular(30),
        ),
      ),
      child: Column(
        children: [
          // Drag-Handle
          Container(
            margin: const EdgeInsets.only(top: 12),
            width: 50,
            height: 5,
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.3),
              borderRadius: BorderRadius.circular(10),
            ),
          ),
          
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Kartenbild
                  Center(
                    child: Hero(
                      tag: 'card_${card.id}',
                      child: ClipRRect(
                        borderRadius: BorderRadius.circular(20),
                        child: Image.network(
                          card.imageUrl,
                          height: 350,
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) {
                            return Container(
                              height: 350,
                              width: 250,
                              color: Colors.grey[800],
                              child: const Icon(
                                Icons.image_not_supported,
                                size: 60,
                                color: Colors.white38,
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                  ),
                  
                  const SizedBox(height: 30),
                  
                  // Kartenname
                  Text(
                    card.name,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  
                  const SizedBox(height: 12),
                  
                  // Set & Nummer
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: Colors.white.withOpacity(0.2),
                      ),
                    ),
                    child: Text(
                      '${card.setName} • ${card.number}',
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.9),
                        fontSize: 16,
                      ),
                    ),
                  ),
                  
                  const SizedBox(height: 12),
                  
                  // Seltenheit
                  Row(
                    children: [
                      Icon(
                        _getRarityIcon(card.rarity),
                        color: _getRarityColor(card.rarity),
                        size: 24,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        card.rarity,
                        style: TextStyle(
                          color: _getRarityColor(card.rarity),
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                  
                  const SizedBox(height: 30),
                  
                  // Aktions-Buttons
                  Row(
                    children: [
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: () {
                            // TODO: Zur Sammlung hinzufügen
                          },
                          icon: const Icon(Icons.add),
                          label: const Text('Zur Sammlung'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF4A90E2),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: onClose,
                          icon: const Icon(Icons.camera_alt),
                          label: const Text('Weiter scannen'),
                          style: OutlinedButton.styleFrom(
                            foregroundColor: Colors.white,
                            side: const BorderSide(color: Colors.white38),
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  IconData _getRarityIcon(String rarity) {
    if (rarity.toLowerCase().contains('rare')) {
      return Icons.stars;
    } else if (rarity.toLowerCase().contains('uncommon')) {
      return Icons.star_half;
    }
    return Icons.star_border;
  }
  
  Color _getRarityColor(String rarity) {
    final rarityLower = rarity.toLowerCase();
    if (rarityLower.contains('secret') || rarityLower.contains('ultra')) {
      return const Color(0xFFFFD700); // Gold
    } else if (rarityLower.contains('rare')) {
      return const Color(0xFF9B59B6); // Lila
    } else if (rarityLower.contains('uncommon')) {
      return const Color(0xFF3498DB); // Blau
    }
    return Colors.grey; // Common
  }
}